// prisma/schema.prisma
// Prisma schema for HRIS SaaS with Supabase + PgBouncer compatibility

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Organization (Multi-tenancy)
model Organization {
  id                   String                @id @default(cuid())
  name                 String
  slug                 String                @unique
  logo                 String?
  subscriptionTier     String                @default("free")
  subscriptionStatus   String                @default("active")
  stripeCustomerId     String?               @unique
  stripeSubscriptionId String?               @unique
  maxEmployees         Int                   @default(10)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  employees            Employee[]
  departments          Department[]
  leaveRequests        LeaveRequest[]
  attendance           Attendance[]
  payrolls             Payroll[]
  settings             OrganizationSettings?

  @@index([slug])
  @@index([stripeCustomerId])
}

// Organization Settings
model OrganizationSettings {
  id                 String       @id @default(cuid())
  organizationId     String       @unique
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workingDaysPerWeek Int          @default(5)
  workStartTime      String       @default("09:00")
  workEndTime        String       @default("17:00")
  timezone           String       @default("Asia/Jakarta")
  annualLeaveQuota   Int          @default(12)
  sickLeaveQuota     Int          @default(12)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

// Employee
model Employee {
  id                String         @id @default(cuid())
  organizationId    String
  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  authId            String?         @unique
  email             String
  firstName         String
  lastName          String
  phoneNumber       String?
  dateOfBirth       DateTime?
  address           String?
  employeeId        String         @unique
  departmentId      String?
  department        Department?    @relation(fields: [departmentId], references: [id])
  position          String
  employmentType    String         @default("full-time")
  joinDate          DateTime       @default(now())
  resignDate        DateTime?
  status            String         @default("active")
  baseSalary        Decimal        @db.Decimal(12, 2)
  currency          String         @default("IDR")
  role              String         @default("employee")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  leaveRequests     LeaveRequest[]
  attendance        Attendance[]
  payrolls          Payroll[]
  managedDepartment Department[]   @relation("DepartmentManager")

  @@index([organizationId])
  @@index([authId])
  @@index([email])
  @@index([departmentId])
}

// Department
model Department {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  managerId      String?
  manager        Employee?    @relation("DepartmentManager", fields: [managerId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  employees      Employee[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// Leave Request
model LeaveRequest {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employeeId     String
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType      String
  startDate      DateTime
  endDate        DateTime
  totalDays      Int
  reason         String
  status         String       @default("pending")
  reviewedBy     String?
  reviewedAt     DateTime?
  reviewNotes    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

// Attendance
model Attendance {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employeeId       String
  employee         Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  date             DateTime     @db.Date
  checkIn          DateTime?
  checkOut         DateTime?
  status           String       @default("present")
  notes            String?
  checkInLocation  String?
  checkOutLocation String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([employeeId, date])
  @@index([organizationId])
  @@index([employeeId])
  @@index([date])
}

// Payroll
model Payroll {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employeeId      String
  employee        Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  period          DateTime     @db.Date
  baseSalary      Decimal      @db.Decimal(12, 2)
  allowances      Decimal      @default(0) @db.Decimal(12, 2)
  overtime        Decimal      @default(0) @db.Decimal(12, 2)
  bonus           Decimal      @default(0) @db.Decimal(12, 2)
  tax             Decimal      @default(0) @db.Decimal(12, 2)
  insurance       Decimal      @default(0) @db.Decimal(12, 2)
  otherDeductions Decimal      @default(0) @db.Decimal(12, 2)
  grossSalary     Decimal      @db.Decimal(12, 2)
  netSalary       Decimal      @db.Decimal(12, 2)
  status          String       @default("pending")
  paidAt          DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([employeeId, period])
  @@index([organizationId])
  @@index([employeeId])
  @@index([period])
  @@index([status])
}
